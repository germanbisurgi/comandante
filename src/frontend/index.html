<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./css/index.css">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline';" />
    <title>Comandante</title>
  </head>
  <body>
    <div id="app">
      <div class="flex-row flex-no-wrap">
        <nav class="sidenav">
          <button class="btn btn-block" :style="{ color: shortcut.color}" v-for="shortcut in shortcuts" @click="sendCommand(shortcut.command)">{{ shortcut.label }}</button>
          <button class="btn btn-block" @click="abort()">Abort</button>
          <button class="btn btn-block" @click="clear()">Clear</button>
          <label for="font-size">Font Size</label>
          <input id="font-size" type="range" min="10" max="20" step="1" v-model="store.state.fontSize" @change="saveSettings">
          <label for="auto-clear">Auto Clear</label>
          <input id="auto-clear" type="checkbox" v-model="store.state.autoClear"  @change="saveSettings">
        </nav>

        <form class="cli flex-grow" @submit="submitCommand">
          <div class="cli-logs">
            <div class="cli-log-container" v-for="log in logs">
              <pre class="cli-log" :data-type="log.type" :style="{ fontSize: store.state.fontSize + 'px' }">{{ log.message }}</pre>
            </div>
          </div>
          <input class="cli-input" type="text" v-model="command">
        </form>
      </div>
    </div>
    <script src="./js/vue.min.js"></script>
    <script src="./js/vuex.min.js"></script>
    <script src="./js/storage.js"></script>
    <script>
      storage = new Storage()
      Vue.use(Vuex)

      const store = new Vuex.Store({
        state: {
          fontSize : storage.getItem('font-size') ?? 11,
          autoClear: storage.getItem('auto-clear') ?? true
        },
        mutations: {
          saveSettings (state) {
            storage.setItem('font-size', state.fontSize)
            storage.setItem('auto-clear', state.autoClear)
          }
        }
      })

      new Vue({
        el: '#app',
        store: store,
        data: {
          command: '',
          shortcuts: [
            { label: 'remove all containers', command: 'docker ps -aq | xargs docker rm -f', color: 'red'},
            { label: 'containers', command: 'docker ps -a', color: 'black'},
            // { label: 'images', command: 'docker images', color: 'black'},
            // { label: 'networks', command: 'docker network ls', color: 'black'},
            // { label: 'volumes', command: 'docker volume ls', color: 'black'},
            // { label: 'prune', command: 'docker system prune -f', color: 'red'}
          ],
          logs: []
        },
        mounted() {
          this.registerEvents()
        },
        methods: {
          registerEvents () {
            const cliLogs = document.querySelector('.cli-logs')

            window.api.on('logs', (event, log) => {
              this.logs.push(log)
              requestAnimationFrame(() => {
                cliLogs.scrollTop = cliLogs.scrollHeight
              })
            })

            window.api.on('clear', (event) => {
              this.clear()
            })
          },
          sendCommand (command) {
            if (store.autoClear) {
              this.clear()
            }
            window.api.send('command', command)
          },
          abort () {
            window.api.send('abort')
          },
          clear () {
            this.logs = []
          },
          submitCommand (e) {
            e.preventDefault()
            this.sendCommand(this.command)
            this.command = ''
          },
          saveSettings () {
            this.$store.commit('saveSettings')
          }
        }
      })
    </script>
  </body>
</html>
